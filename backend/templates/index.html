<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mobile Recharge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Verify Mobile</h2>

        <!-- Step 1: Input Mobile UI -->
        <div id="mobileStep">
            <label for="profileMobile">Mobile Number <span class="required">*</span></label>
            <input
                    type="text"
                    id="profileMobile"
                    placeholder="Enter Mobile Number With Country Code"
                    required
            />
        </div>

        <!-- Step 2: Profile Detail -->
        <div id="profileStep" style="display:none;">
            <label for="firstName">First Name <span class="required">*</span></label>
            <input type="text" id="firstName" placeholder="First Name" />

            <label for="lastName">Last Name <span class="required">*</span></label>
            <input type="text" id="lastName" placeholder="Last Name" />

            <label for="email">Email <span class="required">*</span></label>
            <input type="email" id="email" placeholder="Email" />
        </div>

        <p id="profileError" class="error-message"></p>

        <button id="continueBtn" type="button">Continue</button>
        <button id="createProfileBtn" type="button" style="display:none;">
            Create Profile
        </button>
    </div>
</div>

<script src="{{ url_for('static', filename='js/profile.js') }}"></script>

<div class="container">
    <h2>Mobile Recharge Application</h2>

    <label for="mobileNumber">Mobile Number</label>
    <input type="text" id="mobileNumber" placeholder="+353871234567">
    <small id="mobileError" class="error"></small>

    <label for="amount">Amount (â‚¬)</label>
    <input type="text" id="amount" placeholder="10 - 100">
    <small id="amountError" class="error"></small>

    <button id="initiateBtn" disabled>Pay</button>
    <button id="invoiceBtn" disabled>Download Invoice</button>

    <div class="status" id="statusBox">
        <p id="message"></p>
    </div>
</div>

<script src="{{ url_for('static', filename='js/app.js') }}"></script>

<script>
    const invoiceBtn = document.getElementById("invoiceBtn");
    let lastPaymentId = null;

    const API_BASE_URL =
        "https://3nsivye9u5.execute-api.us-east-1.amazonaws.com/prod";

    initiateBtn.addEventListener("click", async () => {
        statusBox.classList.add("show");
        message.innerText = "Processing payment...";
        initiateBtn.disabled = true;

        const payload = {
            mobileNumber: mobileInput.value,
            amount: Number.parseInt(amountInput.value, 10)
        };

        try {
            const response = await fetch(`${API_BASE_URL}/payments`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error("Payment failed");
            }

            const data = await response.json();

            message.innerText =
                "Payment successful. Payment ID: " +
                data.paymentId +
                " Status: " +
                data.status;

                if (data.status === "SUCCEEDED") {
                lastPaymentId = data.paymentId;
                invoiceBtn.disabled = false;
            }

        } catch (error) {
            console.error("Payment processing failed:", error);
            message.innerText =
                "Unable to process payment. Please try again.";
            initiateBtn.disabled = false;
        }
    });


    invoiceBtn.addEventListener("click", async () => {
    message.innerText = "Generating invoice...";
    message.style.color = "#2196F3"; // Blue for loading
    invoiceBtn.disabled = true; // Disable button to prevent double-clicks

        try {
            const response = await fetch(
<!--                "https://eoy6ga7rqpf3edl.m.pipedream.net",-->
                "https://2vmuq2laf8.execute-api.us-east-1.amazonaws.com/prod/invoice",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        paymentId: lastPaymentId,
                        amount: Number.parseInt(amountInput.value, 10),
                        mobileNumber: mobileInput.value
                    })
                }
            );

            if (!response.ok) {
                throw new Error("Invoice API failed");
            }

            const data = await response.json();
            console.log("API Response:", data); // Debug log

            // Check if invoice generation was successful
            if (data.success && data.invoiceUrl) {
                // Open PDF in new tab
                window.open(data.invoiceUrl, "_blank");
                message.innerText = "Invoice generated successfully!";
                message.style.color = "#4CAF50"; // Green for success
            } else {
                throw new Error(data.error || "No invoice URL in response");
            }

        } catch (error) {
            console.error("Invoice generation error:", error);
            message.innerText = `Unable to generate invoice: ${error.message}`;
            message.style.color = "#f44336"; // Red for error
        } finally {
            invoiceBtn.disabled = false; // Re-enable button
        }

<!--     invoiceBtn.addEventListener("click", async () => {-->
<!--        message.innerText = "Generating invoice...";-->
<!--        message.style.color = "#2196F3";-->
<!--        invoiceBtn.disabled = true;-->

<!--        try {-->
<!--            const response = await fetch(-->
<!--                "https://eoy6ga7rqpf3edl.m.pipedream.net",-->
<!--                {-->
<!--                    method: "POST",-->
<!--                    headers: {-->
<!--                        "Content-Type": "application/json"-->
<!--                    },-->
<!--                    body: JSON.stringify({-->
<!--                        paymentId: lastPaymentId,-->
<!--                        amount: parseInt(amountInput.value),-->
<!--                        mobileNumber: mobileInput.value-->
<!--                    })-->
<!--                }-->
<!--            );-->

<!--            if (!response.ok) {-->
<!--                throw new Error(`HTTP error! status: ${response.status}`);-->
<!--            }-->

<!--            const data = await response.json();-->

<!--            console.log("API Response:", data);-->

<!--            if (data.success && data.invoiceUrl) {-->
<!--                // Update message-->
<!--                message.innerText = "Downloading invoice...";-->

<!--                // Fetch the PDF file-->
<!--                const pdfResponse = await fetch(data.invoiceUrl);-->
<!--                const pdfBlob = await pdfResponse.blob();-->

<!--                // Create download link-->
<!--                const downloadUrl = window.URL.createObjectURL(pdfBlob);-->
<!--                const downloadLink = document.createElement('a');-->
<!--                downloadLink.href = downloadUrl;-->
<!--                downloadLink.download = `Invoice-${lastPaymentId}.pdf`; // Filename-->

<!--                // Trigger download-->
<!--                document.body.appendChild(downloadLink);-->
<!--                downloadLink.click();-->

<!--                // Cleanup-->
<!--                document.body.removeChild(downloadLink);-->
<!--                window.URL.revokeObjectURL(downloadUrl);-->

<!--                message.innerText = "Invoice downloaded successfully!";-->
<!--                message.style.color = "#4CAF50";-->
<!--            } else {-->
<!--                throw new Error(data.error || "No invoice URL in response");-->
<!--            }-->

<!--        } catch (error) {-->
<!--            console.error("Invoice generation error:", error);-->
<!--            message.innerText = `Unable to generate invoice: ${error.message}`;-->
<!--            message.style.color = "#f44336";-->
<!--        } finally {-->
<!--            invoiceBtn.disabled = false;-->
<!--        }   -->

    });

</script>

</body>
</html>
